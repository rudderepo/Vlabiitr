<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SAR ADC Workspace</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPlumb -->
    <script src="https://unpkg.com/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Add instruction panel styles inline */
        .instrucButton {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .instrucButton:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        /* Floating Instructions Panel */
        .floating-instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 700px;
            height: 700px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow: hidden;
            display: none;
            pointer-events: auto;
        }
        
        .floating-instructions-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .floating-instructions-body {
            padding: 20px;
            height: calc(700px - 60px);
            overflow-y: auto;
            font-size: 14px;
        }
        
        .close-instructions {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-instructions:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .instructions-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            pointer-events: auto;
        }
        
        /* Rest of your existing CSS... */
        html, body {
            margin: 0;
            padding: 0;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow-x: hidden;
        }
        
        .circuit-panel, .parameters-panel {
            height: 720px;
            display: flex;
            flex-direction: column;
        }
        
        html, body {
            min-height: 100vh;
        }
        
        .flex-container {
            display: flex;
            width: 1400px;
            min-width: 1400px;
            margin: 20px auto;
            padding: 15px;
            gap: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .circuit-panel {
            width: 980px;
            min-width: 980px;
            max-width: 980px;
            height: 720px;
            display: flex;
            flex-direction: column;
        }
        
        .canvas-wrapper {
            width: 980px;
            min-width: 980px;
            max-width: 980px;
            height: 690px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        
        .parent {
            width: 100%;
            height: 100%;
            padding: 30px 50px;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 10px;
            background-image: linear-gradient(to right, rgba(108, 117, 125, 0.15) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(108, 117, 125, 0.15) 1px, transparent 1px);
            background-size: 25px 25px;
            position: relative;
        }
        
        .parent>div {
            background: white;
            border: 2px solid #adb5bd;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: fit-content;
            height: fit-content;
            justify-self: center;
            align-self: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .parent>div:hover {
            border-color: #0d6efd;
            box-shadow: 0 6px 12px rgba(13, 110, 253, 0.15);
            transform: translateY(-2px);
        }
        
        .parent img {
            max-width: 120px;
            max-height: 120px;
            padding: 8px;
            mix-blend-mode: multiply;
            filter: brightness(1.05) contrast(1.1);
        }
        
        .dot {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border-radius: 50%;
            position: absolute;
            cursor: crosshair;
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .dot:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .dot.connected {
            background: linear-gradient(135deg, #198754 0%, #157347 100%);
        }
        
        .dot.connected:hover {
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
        }
        
        .jtk-endpoint {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        .jtk-connector {
            stroke: #0d6efd;
            stroke-width: 3;
        }
        
        .jtk-connector:hover {
            stroke: #0a58ca;
            stroke-width: 4;
        }
        
        .div1 {
            grid-area: 2 / 2 / 3 / 3;
        }
        
        .div2 {
            grid-area: 2 / 4 / 3 / 5;
        }
        
        .div3 {
            grid-area: 2 / 6 / 5 / 8;
        }
        
        .div4 {
            grid-area: 2 / 9 / 4 / 11;
        }
        
        .div5 {
            grid-area: 5 / 9 / 7 / 12;
        }
        
        .div6 {
            grid-area: 6 / 4 / 8 / 8;
        }
        
        .div7 {
            grid-area: 8 / 2 / 9 / 3;
        }
        
        .header-section {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3);
        }
        
        .workspace-title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 8px 24px;
            font-size: 14px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .control-buttons {
            width: 70%;
            display: flex;
            justify-content: space-evenly;
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            border: 1px solid #dee2e6;
        }
        
        .control-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            min-width: 140px;
            justify-content: center;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .reset-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #b21f2d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .auto-btn {
            background: linear-gradient(135deg, #20c997 0%, #198754 100%);
            color: white;
        }
        
        .auto-btn:hover {
            background: linear-gradient(135deg, #198754 0%, #157347 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
        }
        
        .check-btn {
            background: linear-gradient(135deg, #0dcaf0 0%, #0d6efd 100%);
            color: white;
        }
        
        .check-btn:hover {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
        }
        
        .parameters-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            height: 720px;
            display: flex;
            flex-direction: column;
        }
        
        .parameters-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .card-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        .simulation-container {
            width: 1400px;
            min-width: 1400px;
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 25px;
            display: none;
            border: 1px solid #dee2e6;
        }
        
        .simulation-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .simulation-header {
            background: linear-gradient(135deg, #6f42c1 0%, #0d6efd 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(111, 66, 193, 0.3);
        }
        
        .binary-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .binary-output-display {
            font-size: 2.8rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            color: #2c3e50;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .bits-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .bit-box {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .bit-index {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.9;
        }
        
        .bit-box.active {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            transform: scale(1.15);
            box-shadow: 0 6px 12px rgba(13, 110, 253, 0.4);
        }
        
        .bit-box.set {
            background: linear-gradient(135deg, #198754 0%, #157347 100%);
            box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
        }
        
        .bit-box.cleared {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .step-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        
        .step-item {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid #6c757d;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .step-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .step-item.active {
            border-left-color: #0d6efd;
            background: linear-gradient(135deg, #e7f3ff 0%, #d4e6ff 100%);
        }
        
        .step-item.completed {
            border-left-color: #198754;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .metrics-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .metric-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .metric-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: #0d6efd;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #0d6efd;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .metric-label {
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .simulation-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .simulation-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 160px;
            justify-content: center;
        }
        
        .simulation-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .simulation-btn:not(:disabled):hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .connection-status {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 8px;
            font-size: 14px;
            text-align: left;
            color: #856404;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .connection-status.connected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: #198754;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        #tempLine {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 5;
        }
        
        #tempLine line {
            stroke: #0d6efd;
            stroke-width: 3;
            stroke-dasharray: 5, 5;
            animation: dash 1s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: 20;
            }
        }
        
        .form-control, .form-select, .form-range {
            border-radius: 8px;
            border: 2px solid #ced4da;
            font-size: 14px;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.3rem rgba(13, 110, 253, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
            color: #495057;
        }
        
        .form-range::-webkit-slider-thumb {
            background: #0d6efd;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .btn-group-responsive {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }
        
        .btn-group-responsive .btn {
            padding: 12px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-group-responsive .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>

<body>
    <!-- Floating Instructions Overlay -->
    <div class="instructions-overlay" id="instructionsOverlay"></div>
    
    <!-- Floating Instructions Panel -->
    <div class="floating-instructions" id="floatingInstructions">
        <div class="floating-instructions-header">
            <h5 class="mb-0"><i class="bi bi-book me-2"></i> SAR ADC Instructions</h5>
            <button class="close-instructions" id="closeInstructions">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="floating-instructions-body">
            <p>
                This simulator demonstrates the working principle of a
                <strong>Successive Approximation Register (SAR) Analog-to-Digital Converter</strong>
                which uses binary search algorithm to convert analog signals to digital.
            </p>

            <h6 class="mt-3"><strong>Workflow (Follow Strictly)</strong></h6>
            <ol>
                <li>Make circuit connections (7 connections required)</li>
                <li>Check connections using "Check Connections" button</li>
                <li>Set ADC parameters (Bits, Vref, Input Voltage, Step Speed)</li>
                <li>Click "Start Simulation"</li>
                <li>Use Next Step, Previous Step, or Auto Run to see conversion process</li>
                <li>Observe binary output and step-by-step comparison</li>
                <li>Reset if required</li>
            </ol>

            <h6 class="mt-3"><strong>Parameter Setup</strong></h6>
            <ul>
                <li><strong>Number of Bits:</strong> Select resolution (4-bit to 16-bit)</li>
                <li><strong>Reference Voltage (Vref):</strong> Set reference voltage (1-24V)</li>
                <li><strong>Step Speed:</strong> Control simulation speed (Fast to Very Slow)</li>
                <li><strong>Input Voltage:</strong> Adjust analog input using slider (0 to Vref)</li>
            </ul>

    

            <div class="alert alert-warning p-2 mt-3 mb-0">
                <strong>Note:</strong> Simulation remains locked until all 7 connections are correctly made.
            </div>
            
            <div class="alert alert-info p-2 mt-3 mb-0">
                <strong>Tip:</strong> Use "Auto-Connect" button to quickly set up all required connections.
            </div>
            
            <div class="alert alert-success p-2 mt-3 mb-0">
                <strong>Key Concept:</strong> SAR ADC is faster than Single Slope but requires precise DAC and comparator.
            </div>
        </div>
    </div>

    <div class="col-11 header-section" style="margin-left:70px; margin-top: 10px;">
        <h5>SAR ADC Circuit Workspace</h5>
    </div>
    <div class="flex-container">
        <!-- CIRCUIT WORKSPACE (70%) -->
        <div class="circuit-panel">
            <div class="canvas-wrapper">
                <div class="parent" id="workspace">
                    <!-- VIN -->
                    <div class="div1">
                        <img src="./imagess/vin.png" alt="VIN Source">
                        <div class="dot" id="dot1" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- SAMPLE & HOLD -->
                    <div class="div2">
                        <img src="./imagess/sample.png" alt="Sample & Hold">
                        <div class="dot" id="dot2" style="left:-7px; top:50%"></div>
                        <div class="dot" id="dot3" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- COMPARATOR -->
                    <div class="div3">
                        <img src="./imagess/camparator1.png" alt="Comparator">
                        <div class="dot" id="dot4" style="left:-7px; top:30%"></div>
                        <div class="dot" id="dot5" style="left:-7px; top:70%"></div>
                        <div class="dot" id="dot6" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- CONTROL LOGIC -->
                    <div class="div4">
                        <img src="./imagess/controllogic.png" alt="Control Logic">
                        <div class="dot" id="dot7" style="left:-7px; top:50%"></div>
                        <div class="dot" id="dot8" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- SAR -->
                    <div class="div5">
                        <img src="./imagess/sar.png" alt="SAR Register">
                        <div class="dot" id="dot9" style="left:-7px; top:50%"></div>
                        <div class="dot" id="dot10" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- DAC -->
                    <div class="div6">
                        <img src="./imagess/dac.png" alt="DAC">
                        <div class="dot" id="dot11" style="left:-7px; top:30%"></div>
                        <div class="dot" id="dot12" style="left:-7px; top:70%"></div>
                        <div class="dot" id="dot13" style="right:-7px; top:50%"></div>
                    </div>

                    <!-- VREF -->
                    <div class="div7">
                        <img src="./imagess/vref.png" alt="VREF Source">
                        <div class="dot" id="dot14" style="right:-7px; top:50%"></div>
                    </div>
                </div>

                <!-- CONTROL BUTTONS -->
                <div class="control-buttons">
                    <button class="control-btn reset-btn" id="resetBtn">
                        <i class="fas fa-trash-alt"></i> Clear All
                    </button>
                    <button class="control-btn auto-btn" id="autoBtn">
                        <i class="fas fa-bolt"></i> Auto-Connect
                    </button>
                    <button class="control-btn check-btn" id="checkBtn">
                        <i class="fas fa-check-circle"></i> Check Connections
                    </button>
                </div>
            </div>
        </div>

        <!-- PARAMETERS PANEL (30%) -->
        <div class="parameters-panel">
            <div class="header-section" style="width: 360px; display: flex; justify-content: space-between; align-items: center;">
                <h5 style="margin: 0;">Simulation Parameters</h5>
                <button class="instrucButton" title="Show Instructions">
                    <i class="bi bi-info-circle"></i>
                </button>
            </div>

            <div class="parameters-card" style="width: 360px;">
                <div class="card-body" style="width: 360px;">
                    <!-- Connection Status -->
                    <div id="connectionStatus" class="connection-status">
                        <span id="connectionStatusText">Connect the circuit components to begin</span>
                    </div>

                    <div class="mb-3">
                        <label for="resolution" class="form-label"> Number of Bits</label>
                        <select class="form-select" id="resolution">
                            <option value="4">4-bit</option>
                            <option value="8" selected>8-bit</option>
                            <option value="10">10-bit</option>
                            <option value="12">12-bit</option>
                            <option value="16">16-bit</option>
                        </select>
                    </div>

                    <div class="mb-3" style="display: none;">
                        <label for="clockFreq" class="form-label">Clock Frequency (kHz)</label>
                        <input type="number" class="form-control" id="clockFreq" min="0.1" max="1000" step="0.1"
                            value="100">
                    </div>

                    <div class="mb-3">
                        <label for="vref" class="form-label">Reference Voltage (V<sub>REF</sub>)</label>
                        <input type="number" class="form-control" id="vref" min="1" max="24" step="0.1" value="5">
                    </div>

                    <div class="mb-3">
                        <label for="stepDelay" class="form-label">Step Speed</label>
                        <select class="form-select" id="stepDelay">
                            <option value="250">Fast (0.25s/step)</option>
                            <option value="500">Medium (0.5s/step)</option>
                            <option value="1000" selected>Normal (1s/step)</option>
                            <option value="1500">Slow (1.5s/step)</option>
                            <option value="2000">Very Slow (2s/step)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="voltageSlider" class="form-label">Input Voltage: <span id="voltageValue">3.20</span>
                            V</label>
                        <input type="range" class="form-range" id="voltageSlider" min="0" max="5" step="0.01"
                            value="3.2">
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">0V</small>
                            <small class="text-muted" id="maxVoltageLabel">5V</small>
                        </div>
                    </div>

                    <div class="btn-group-responsive">
                        <button id="startSimulation" class="btn btn-primary" disabled>
                            <i class="fas fa-play-circle"></i> Start Simulation
                        </button>
                        <button id="resetParamsBtn" class="btn btn-danger">
                            <i class="fas fa-redo"></i> Reset Parameters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIMULATION VISUALIZATION -->
    <div id="simulationVisualization" class="simulation-container">
        <div class="simulation-header">
            <h5>SAR ADC Step-by-Step Conversion Process</h5>
        </div>

        <div class="binary-display">
            <h6>Binary Output (MSB to LSB)</h6>
            <div id="binaryOutputDisplay" class="binary-output-display">00000000</div>

            <div class="bits-container" id="bitsContainer">
                <!-- Bits will be generated here -->
            </div>

            <div class="text-center mt-3">
                <small>Current Bit Testing: <span id="currentBitDisplay" class="fw-bold">MSB (Bit 7)</span></small>
            </div>
        </div>

        <div class="metrics-container">
            <div class="metric-box">
                <div class="metric-value" id="dacOutput">0.000 V</div>
                <div class="metric-label">DAC Output</div>
            </div>
            <div class="metric-box">
                <div class="metric-value" id="stepCounter">0/8</div>
                <div class="metric-label">Step</div>
            </div>
            <div class="metric-box">
                <div class="metric-value" id="decimalOutput">0</div>
                <div class="metric-label">Decimal Value</div>
            </div>
        </div>

        <div class="step-display">
            <h6 class="mb-3">Conversion Steps</h6>
            <div id="stepsList">
                <div class="step-item">Connect all circuit components and click "Start Simulation" to begin
                    conversion...</div>
            </div>
        </div>

        <div class="simulation-controls">
            <button id="prevStepBtn" class="simulation-btn btn btn-secondary" disabled>
                <i class="fas fa-step-backward"></i> Previous Step
            </button>
            <button id="nextStepBtn" class="simulation-btn btn btn-success">
                <i class="fas fa-step-forward"></i> Next Step
            </button>
            <button id="autoRunBtn" class="simulation-btn btn btn-primary">
                <i class="fas fa-play"></i> Auto Run
            </button>
            <button id="resetSimBtn" class="simulation-btn btn btn-danger">
                <i class="fas fa-stop"></i> Reset
            </button>
        </div>
    </div>

    <!-- TEMPORARY SVG LINE FOR DRAGGING -->
    <svg id="tempLine">
        <line id="tempLineElement" x1="0" y1="0" x2="0" y2="0" style="display: none;" />
    </svg>

    <script>
        // Instructions Panel Functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Get elements
            const instrucButton = document.querySelector('.instrucButton');
            const floatingInstructions = document.getElementById('floatingInstructions');
            const instructionsOverlay = document.getElementById('instructionsOverlay');
            const closeInstructions = document.getElementById('closeInstructions');
            
            // Toggle instructions panel
            function toggleInstructions() {
                if (floatingInstructions.style.display === 'block') {
                    floatingInstructions.style.display = 'none';
                    instructionsOverlay.style.display = 'none';
                } else {
                    floatingInstructions.style.display = 'block';
                    instructionsOverlay.style.display = 'block';
                }
            }
            
            // Event listeners
            if (instrucButton) {
                instrucButton.addEventListener('click', toggleInstructions);
            }
            
            if (closeInstructions) {
                closeInstructions.addEventListener('click', toggleInstructions);
            }
            
            if (instructionsOverlay) {
                instructionsOverlay.addEventListener('click', toggleInstructions);
            }
            
            // Close with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && floatingInstructions.style.display === 'block') {
                    toggleInstructions();
                }
            });
        });

        jsPlumb.ready(function () {
            const instance = jsPlumb.getInstance({
                Container: "workspace",
                Connector: ["Bezier", { curviness: 60 }],
                PaintStyle: {
                    stroke: "#0d6efd",
                    strokeWidth: 3
                },
                HoverPaintStyle: {
                    stroke: "#0a58ca",
                    strokeWidth: 4
                },
                Endpoint: ["Blank", {}],
                ConnectionOverlays: []
            });

            // CORRECTED Required connections for SAR ADC
            const requiredConnections = [
                ['dot1', 'dot2'],   // VIN to Sample & Hold Input
                ['dot3', 'dot4'],   // Sample & Hold Output to Comparator Plus Input
                ['dot6', 'dot7'],   // Comparator Output to Control Logic Input
                ['dot8', 'dot10'],  // Control Logic Output to SAR Output
                ['dot13', 'dot9'],  // DAC Output to SAR Input (feedback loop)
                ['dot14', 'dot12'], // VREF to DAC Reference Input
                ['dot11', 'dot5']   // DAC Output to Comparator Minus Input
            ];

            // SAR ADC Simulation Variables
            let simulationActive = false;
            let currentStep = 0;
            let totalSteps = 8;
            let binaryWord = [];
            let testWord = 0;
            let vin = 3.2;
            let vref = 5;
            let stepDelay = 1000;
            let autoRunInterval = null;
            let isAutoRunning = false;

            // DOM Elements for simulation
            const simulationContainer = document.getElementById('simulationVisualization');
            const bitsContainer = document.getElementById('bitsContainer');
            const binaryOutputDisplay = document.getElementById('binaryOutputDisplay');
            const currentBitDisplay = document.getElementById('currentBitDisplay');
            const dacOutput = document.getElementById('dacOutput');
            const stepCounter = document.getElementById('stepCounter');
            const decimalOutput = document.getElementById('decimalOutput');
            const stepsList = document.getElementById('stepsList');
            const prevStepBtn = document.getElementById('prevStepBtn');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const autoRunBtn = document.getElementById('autoRunBtn');
            const resetSimBtn = document.getElementById('resetSimBtn');
            const startSimulationBtn = document.getElementById('startSimulation');

            // Initialize simulation display
            function initSimulationDisplay() {
                totalSteps = parseInt(document.getElementById('resolution').value);
                vin = parseFloat(document.getElementById('voltageSlider').value);
                vref = parseFloat(document.getElementById('vref').value);
                stepDelay = parseInt(document.getElementById('stepDelay').value);

                currentStep = 0;
                binaryWord = new Array(totalSteps).fill(0);
                testWord = 0;

                // Clear steps list
                stepsList.innerHTML = '<div class="step-item">Starting conversion process...</div>';

                // Generate bit boxes - Display from MSB to LSB (left to right)
                bitsContainer.innerHTML = '';
                for (let i = totalSteps - 1; i >= 0; i--) {
                    const bitBox = document.createElement('div');
                    bitBox.className = 'bit-box';
                    bitBox.id = `bit-${i}`;
                    bitBox.innerHTML = `<div>${binaryWord[i]}</div><div class="bit-index">b${i}</div>`;
                    bitBox.title = `Bit ${i} (${i === totalSteps - 1 ? 'MSB' : i === 0 ? 'LSB' : ''})`;
                    bitsContainer.appendChild(bitBox);
                }

                updateSimulationDisplay();
            }

            // Update simulation display
            function updateSimulationDisplay() {
                // Update binary display (MSB to LSB)
                const displayBinary = [...binaryWord].reverse().join('');
                binaryOutputDisplay.textContent = displayBinary;

                // Update bit boxes
                for (let i = totalSteps - 1; i >= 0; i--) {
                    const bitEl = document.getElementById(`bit-${i}`);
                    if (bitEl) {
                        // Update the bit value
                        bitEl.innerHTML = `<div>${binaryWord[i]}</div><div class="bit-index">b${i}</div>`;
                        bitEl.className = 'bit-box';

                        // Check if this is the current bit being tested
                        const currentBitPosition = totalSteps - 1 - currentStep;

                        if (i === currentBitPosition && currentStep < totalSteps) {
                            bitEl.classList.add('active');
                        } else if (binaryWord[i] === 1) {
                            bitEl.classList.add('set');
                        } else {
                            bitEl.classList.add('cleared');
                        }
                    }
                }

                // Update current bit display
                if (currentStep < totalSteps) {
                    const currentBitPosition = totalSteps - 1 - currentStep;
                    let bitType = '';
                    if (currentBitPosition === totalSteps - 1) {
                        bitType = 'MSB';
                    } else if (currentBitPosition === 0) {
                        bitType = 'LSB';
                    } else {
                        bitType = `Bit ${currentBitPosition}`;
                    }
                    currentBitDisplay.textContent = `${bitType} (Bit ${currentBitPosition})`;
                } else {
                    currentBitDisplay.textContent = 'Conversion Complete';
                }

                // Update step counter
                stepCounter.textContent = `${currentStep}/${totalSteps}`;

                // Update DAC output
                const dacVoltage = (testWord / Math.pow(2, totalSteps)) * vref;
                dacOutput.textContent = dacVoltage.toFixed(3) + ' V';

                // Update decimal output
                let decimalValue = 0;
                for (let i = 0; i < totalSteps; i++) {
                    decimalValue += binaryWord[i] * Math.pow(2, i);
                }
                decimalOutput.textContent = decimalValue;

                // Update button states
                prevStepBtn.disabled = currentStep === 0;
                nextStepBtn.disabled = currentStep >= totalSteps;
                autoRunBtn.disabled = currentStep >= totalSteps;

                if (isAutoRunning) {
                    autoRunBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    autoRunBtn.classList.remove('btn-primary');
                    autoRunBtn.classList.add('btn-warning');
                } else {
                    autoRunBtn.innerHTML = '<i class="fas fa-play"></i> Auto Run';
                    autoRunBtn.classList.remove('btn-warning');
                    autoRunBtn.classList.add('btn-primary');
                }
            }

            // Add step to display
            function addStep(stepNumber, bitPosition, dacVoltage, comparisonResult, bitValue) {
                const stepItem = document.createElement('div');
                stepItem.className = `step-item ${stepNumber === currentStep - 1 ? 'active' : 'completed'}`;

                const bitType = bitPosition === totalSteps - 1 ? 'MSB' :
                    bitPosition === 0 ? 'LSB' : `Bit ${bitPosition}`;

                const resultClass = comparisonResult === 'higher' ? 'text-success' : 'text-danger';
                const resultText = comparisonResult === 'higher' ? 'Vin ≥ Vdac' : 'Vin < Vdac';
                const decision = comparisonResult === 'higher' ? 'Set bit = 1' : 'Clear bit = 0';

                stepItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Step ${stepNumber + 1}: Testing ${bitType}</strong><br>
                            <small>DAC Output: <span class="fw-bold">${dacVoltage.toFixed(3)}V</span></small><br>
                            <small class="${resultClass}">${resultText}</small> → <span class="fw-bold">${decision}</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">Bit ${bitPosition}</small><br>
                            <span class="badge ${bitValue === 1 ? 'bg-success' : 'bg-danger'}">${bitValue}</span>
                        </div>
                    </div>
                `;

                stepsList.prepend(stepItem);

                // Remove old steps if too many
                const allSteps = stepsList.querySelectorAll('.step-item');
                if (allSteps.length > 10) {
                    allSteps[allSteps.length - 1].remove();
                }

                // Scroll to top
                stepsList.parentElement.scrollTop = 0;
            }

            // Perform one SAR step
            function performSARStep() {
                if (currentStep >= totalSteps) {
                    completeSimulation();
                    return;
                }

                const bitPosition = totalSteps - 1 - currentStep;

                // Set current bit to 1 for testing
                testWord = testWord | (1 << bitPosition);

                // Calculate test voltage
                const testVoltage = (testWord / Math.pow(2, totalSteps)) * vref;

                // Compare with input voltage
                const comparisonResult = vin >= testVoltage ? 'higher' : 'lower';

                // Set bit based on comparison
                let bitValue;
                if (comparisonResult === 'higher') {
                    binaryWord[bitPosition] = 1;
                    bitValue = 1;
                } else {
                    binaryWord[bitPosition] = 0;
                    testWord = testWord & ~(1 << bitPosition);
                    bitValue = 0;
                }

                // Add step to display
                addStep(currentStep, bitPosition, testVoltage, comparisonResult, bitValue);

                // Update display
                updateSimulationDisplay();

                currentStep++;

                // Check if simulation is complete
                if (currentStep >= totalSteps) {
                    completeSimulation();
                }
            }

            // Go to previous step
            function goToPreviousStep() {
                if (currentStep > 0) {
                    currentStep--;
                    const bitPosition = totalSteps - 1 - currentStep;

                    // Remove the last step from display
                    const firstStep = stepsList.querySelector('.step-item');
                    if (firstStep) {
                        firstStep.remove();
                    }

                    // Revert binary word and test word for this bit position
                    binaryWord[bitPosition] = 0;
                    testWord = testWord & ~(1 << bitPosition);

                    // Update display
                    updateSimulationDisplay();
                }
            }

            // Complete simulation
            function completeSimulation() {
                if (isAutoRunning) {
                    stopAutoRun();
                }

                let decimalValue = 0;
                for (let i = 0; i < totalSteps; i++) {
                    decimalValue += binaryWord[i] * Math.pow(2, i);
                }

                const actualVoltage = (decimalValue / Math.pow(2, totalSteps)) * vref;

                const stepItem = document.createElement('div');
                stepItem.className = 'step-item completed';
                stepItem.innerHTML = `
                    <div class="text-center">
                        <strong class="text-success">CONVERSION COMPLETE!</strong><br>
                        <small>Final Digital Output: <span class="fw-bold">${decimalValue}</span> (${[...binaryWord].reverse().join('')})<br>
                        Represents: ${actualVoltage.toFixed(3)}V of ${vin.toFixed(3)}V input<br>
                        ${totalSteps}-bit resolution achieved in ${totalSteps} steps</small>
                    </div>
                `;
                stepsList.prepend(stepItem);

                nextStepBtn.disabled = true;
                autoRunBtn.disabled = true;

                Swal.fire({
                    title: 'Conversion Complete!',
                    html: `<div class="text-center">
                             <h4 class="mt-3">SAR ADC Conversion Successful!</h4>
                           </div>
                           <div class="text-start mt-3">
                             <b>Final Results:</b><br>
                             • Digital Output: ${decimalValue} (${[...binaryWord].reverse().join('')})<br>
                             • Analog Input: ${vin.toFixed(3)}V<br>
                             • Digital Equivalent: ${actualVoltage.toFixed(3)}V<br>
                             • Resolution: ${totalSteps} bits<br>
                             • Steps Taken: ${totalSteps}
                           </div>`,
                    icon: 'success',
                    confirmButtonText: 'Great!',
                    confirmButtonColor: '#0d6efd',
                    width: 500
                });
            }

            // Start auto-run
            function startAutoRun() {
                if (isAutoRunning) return;

                isAutoRunning = true;
                autoRunInterval = setInterval(() => {
                    performSARStep();
                    if (currentStep >= totalSteps) {
                        stopAutoRun();
                    }
                }, stepDelay);

                updateSimulationDisplay();
            }

            // Stop auto-run
            function stopAutoRun() {
                if (autoRunInterval) {
                    clearInterval(autoRunInterval);
                    autoRunInterval = null;
                }
                isAutoRunning = false;
                updateSimulationDisplay();
            }

            // Reset simulation
            function resetSimulation() {
                stopAutoRun();
                simulationActive = false;
                currentStep = 0;
                binaryWord = new Array(totalSteps).fill(0);
                testWord = 0;
                stepsList.innerHTML = '<div class="step-item">Connect all circuit components and click "Start Simulation" to begin conversion...</div>';
                if (simulationActive) {
                    initSimulationDisplay();
                }
            }

            // Update connection status and dot colors
            function updateConnectionStatus() {
                const allConnections = instance.getConnections();
                const userConnections = [];

                // Reset all dots to red
                document.querySelectorAll('.dot').forEach(dot => {
                    dot.classList.remove('connected');
                });

                // Mark connected dots as green
                allConnections.forEach(conn => {
                    if (conn.source && conn.source.classList) {
                        conn.source.classList.add('connected');
                    }
                    if (conn.target && conn.target.classList) {
                        conn.target.classList.add('connected');
                    }
                    userConnections.push([conn.sourceId, conn.targetId]);
                });

                let correct = 0;
                requiredConnections.forEach(req => {
                    const found = userConnections.some(conn =>
                        (conn[0] === req[0] && conn[1] === req[1]) ||
                        (conn[0] === req[1] && conn[1] === req[0])
                    );
                    if (found) correct++;
                });

                const statusDiv = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionStatusText');

                if (correct === requiredConnections.length && userConnections.length === requiredConnections.length) {
                    statusDiv.className = 'connection-status connected';
                    statusText.innerHTML = `<i class="fas fa-check-circle"></i> All ${correct} connections correct! Ready to simulate.`;
                    startSimulationBtn.disabled = false;
                    simulationContainer.classList.add('active');
                } else if (correct > 0) {
                    statusDiv.className = 'connection-status';
                    statusText.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${correct} of ${requiredConnections.length} connections correct.`;
                    startSimulationBtn.disabled = true;
                    simulationContainer.classList.remove('active');
                } else {
                    statusDiv.className = 'connection-status disconnected';
                    statusText.innerHTML = `<i class="fas fa-times-circle"></i> No connections made. Connect the circuit first.`;
                    startSimulationBtn.disabled = true;
                    simulationContainer.classList.remove('active');
                }
            }

            // Manual drag and drop implementation
            let isDragging = false;
            let startDot = null;
            const tempLine = document.getElementById('tempLineElement');

            // Mouse down on dot
            document.querySelectorAll('.dot').forEach(dot => {
                dot.addEventListener('mousedown', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    isDragging = true;
                    startDot = this;

                    const rect = startDot.getBoundingClientRect();
                    const startX = rect.left + rect.width / 2;
                    const startY = rect.top + rect.height / 2;

                    tempLine.setAttribute('x1', startX);
                    tempLine.setAttribute('y1', startY);
                    tempLine.setAttribute('x2', startX);
                    tempLine.setAttribute('y2', startY);
                    tempLine.style.display = 'block';

                    document.body.style.cursor = 'crosshair';
                });
            });

            // Mouse move
            document.addEventListener('mousemove', function (e) {
                if (isDragging && startDot) {
                    tempLine.setAttribute('x2', e.clientX);
                    tempLine.setAttribute('y2', e.clientY);
                }
            });

            // Mouse up
            document.addEventListener('mouseup', function (e) {
                if (isDragging && startDot) {
                    tempLine.style.display = 'none';

                    const endDot = document.elementFromPoint(e.clientX, e.clientY);

                    if (endDot && endDot.classList.contains('dot') && endDot !== startDot) {
                        const existingConnections = instance.getConnections({
                            source: startDot.id,
                            target: endDot.id
                        });

                        const reverseConnections = instance.getConnections({
                            source: endDot.id,
                            target: startDot.id
                        });

                        if (existingConnections.length === 0 && reverseConnections.length === 0) {
                            instance.connect({
                                source: startDot,
                                target: endDot,
                                anchors: ["Center", "Center"],
                                connector: ["Bezier", { curviness: 60 }],
                                paintStyle: {
                                    stroke: "#0d6efd",
                                    strokeWidth: 3
                                }
                            });
                        }
                    }

                    startDot = null;
                    isDragging = false;
                    document.body.style.cursor = 'default';

                    setTimeout(updateConnectionStatus, 50);
                }
            });

            // Ensure components themselves are not draggable
            instance.setDraggable(document.querySelectorAll(".parent > div"), false);

            // Listen for connection events
            instance.bind("connection", function (conn) {
                updateConnectionStatus();
            });

            instance.bind("connectionDetached", function (conn) {
                updateConnectionStatus();
            });

            // Reset button functionality
            document.getElementById('resetBtn').addEventListener('click', function () {
                Swal.fire({
                    title: 'Clear All Connections?',
                    text: 'This will remove all circuit connections.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, clear all',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        instance.deleteEveryConnection();
                        updateConnectionStatus();
                        resetSimulation();
                        Swal.fire({
                            title: 'Connections Cleared',
                            text: 'All circuit connections have been removed.',
                            icon: 'success',
                            timer: 1500
                        });
                    }
                });
            });

            // Auto-Connect button functionality
            document.getElementById('autoBtn').addEventListener('click', function () {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';

                instance.deleteEveryConnection();

                requiredConnections.forEach(([sourceId, targetId], index) => {
                    setTimeout(() => {
                        const source = document.getElementById(sourceId);
                        const target = document.getElementById(targetId);

                        if (source && target) {
                            instance.connect({
                                source: source,
                                target: target,
                                anchors: ["Center", "Center"],
                                connector: ["Bezier", { curviness: 60 }],
                                paintStyle: {
                                    stroke: "#0d6efd",
                                    strokeWidth: 3
                                }
                            });
                        }
                    }, index * 150);
                });

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;

                    updateConnectionStatus();
                    const allConnections = instance.getConnections();

                    if (allConnections.length === requiredConnections.length) {
                        Swal.fire({
                            title: 'Success!',
                            text: `All ${requiredConnections.length} connections automatically created!`,
                            icon: 'success',
                            timer: 2000
                        });
                    } else {
                        Swal.fire({
                            title: 'Warning',
                            text: 'Some connections may not have been created properly.',
                            icon: 'warning',
                            timer: 2000
                        });
                    }
                }, requiredConnections.length * 150 + 300);
            });

            // Check Connections button functionality
            document.getElementById('checkBtn').addEventListener('click', function () {
                const allConnections = instance.getConnections();
                const userConnections = [];

                allConnections.forEach(conn => {
                    userConnections.push([conn.sourceId, conn.targetId]);
                });

                let correct = 0;
                let missing = [];

                requiredConnections.forEach(req => {
                    const found = userConnections.some(conn =>
                        (conn[0] === req[0] && conn[1] === req[1]) ||
                        (conn[0] === req[1] && conn[1] === req[0])
                    );

                    if (found) {
                        correct++;
                    } else {
                        missing.push(req);
                    }
                });

                const totalRequired = requiredConnections.length;
                let message = '';
                let icon = 'info';

                if (correct === totalRequired && userConnections.length === totalRequired) {
                    message = `✅ Perfect! All ${correct} required connections are correct!\nSAR ADC circuit is properly connected.`;
                    icon = 'success';
                } else if (correct === totalRequired && userConnections.length > totalRequired) {
                    message = `⚠️ Almost perfect! All required connections present but you have ${userConnections.length - totalRequired} extra connection(s).`;
                    icon = 'warning';
                } else {
                    message = `📊 Connection Check:\n✅ Correct: ${correct} out of ${totalRequired}\n❌ Missing: ${missing.length}`;
                    if (missing.length > 0) {
                        const missingList = missing.map(conn =>
                            `• ${conn[0].replace('dot', '')} ↔ ${conn[1].replace('dot', '')}`
                        ).join('\n');
                        message += `\n\nMissing connections:\n${missingList}`;
                    }
                }

                Swal.fire({
                    title: 'Connection Check',
                    text: message,
                    icon: icon,
                    width: 500
                });

                updateConnectionStatus();
            });

            // Update voltage slider when VREF changes
            function updateVoltageSlider() {
                const vrefInput = document.getElementById('vref');
                const voltageSlider = document.getElementById('voltageSlider');
                const maxVoltageLabel = document.getElementById('maxVoltageLabel');

                const currentVref = parseFloat(vrefInput.value) || 5;

                voltageSlider.max = currentVref;
                voltageSlider.step = currentVref / 100;

                maxVoltageLabel.textContent = currentVref.toFixed(1) + 'V';

                const currentVoltage = parseFloat(voltageSlider.value);
                if (currentVoltage > currentVref) {
                    voltageSlider.value = currentVref;
                    document.getElementById('voltageValue').textContent = currentVref.toFixed(2);
                }
            }

            // Reset Parameters button
            document.getElementById('resetParamsBtn').addEventListener('click', function () {
                Swal.fire({
                    title: 'Reset Parameters?',
                    text: 'This will reset all simulation parameters to default values.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('resolution').value = 8;
                        document.getElementById('clockFreq').value = 100;
                        document.getElementById('vref').value = 5;
                        document.getElementById('stepDelay').value = 1000;
                        document.getElementById('voltageSlider').value = 3.2;
                        document.getElementById('voltageValue').textContent = '3.20';
                        updateVoltageSlider();
                        resetSimulation();

                        Swal.fire({
                            title: 'Parameters Reset',
                            text: 'All parameters have been reset to default values.',
                            icon: 'success',
                            timer: 1500
                        });
                    }
                });
            });

            // Voltage slider update
            document.getElementById('voltageSlider').addEventListener('input', function (e) {
                document.getElementById('voltageValue').textContent = parseFloat(e.target.value).toFixed(2);
                vin = parseFloat(e.target.value);
                if (simulationActive) {
                    updateSimulationDisplay();
                }
            });

            // VREF input update
            document.getElementById('vref').addEventListener('input', function () {
                updateVoltageSlider();
                vref = parseFloat(this.value);
                if (simulationActive) {
                    updateSimulationDisplay();
                }
            });

            // Resolution change
            document.getElementById('resolution').addEventListener('change', function () {
                totalSteps = parseInt(this.value);
                if (simulationActive) {
                    resetSimulation();
                }
            });

            // Step delay change
            document.getElementById('stepDelay').addEventListener('change', function () {
                stepDelay = parseInt(this.value);
                if (isAutoRunning) {
                    stopAutoRun();
                    startAutoRun();
                }
            });

            // Start Simulation button
            document.getElementById('startSimulation').addEventListener('click', function () {
                const allConnections = instance.getConnections();
                const userConnections = [];

                allConnections.forEach(conn => {
                    userConnections.push([conn.sourceId, conn.targetId]);
                });

                let correct = 0;
                requiredConnections.forEach(req => {
                    const found = userConnections.some(conn =>
                        (conn[0] === req[0] && conn[1] === req[1]) ||
                        (conn[0] === req[1] && conn[1] === req[0])
                    );
                    if (found) correct++;
                });

                if (correct === requiredConnections.length) {
                    simulationActive = true;
                    stopAutoRun();
                    currentStep = 0;
                    binaryWord = [];
                    testWord = 0;

                    initSimulationDisplay();

                    const resolution = document.getElementById('resolution').value;
                    const vref = document.getElementById('vref').value;
                    const vin = document.getElementById('voltageSlider').value;
                    const clockFreq = document.getElementById('clockFreq').value;

                    Swal.fire({
                        title: 'Simulation Starting!',
                        html: `<div class="text-center">
                                 <i class="fas fa-play-circle text-primary" style="font-size: 48px;"></i>
                                 <h4 class="mt-3">All connections verified!</h4>
                               </div>
                               <div class="text-start mt-3">
                                 <b>Simulation Parameters:</b><br>
                                 • Resolution: ${resolution}-bit<br>
                                 • Vref: ${vref}V<br>
                                 • Vin: ${vin}V<br>
                                 • Clock: ${clockFreq} kHz<br><br>
                                 <small>Use the simulation controls below to step through the conversion process.</small>
                               </div>`,
                        icon: 'success',
                        confirmButtonText: 'Start Simulation',
                        confirmButtonColor: '#0d6efd',
                        width: 500
                    });
                } else {
                    Swal.fire({
                        title: 'Incomplete Connections',
                        text: 'Please complete all circuit connections before starting simulation.',
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#dc3545'
                    });
                }
            });

            // Simulation control buttons
            nextStepBtn.addEventListener('click', function () {
                if (currentStep < totalSteps) {
                    performSARStep();
                }
            });

            prevStepBtn.addEventListener('click', function () {
                if (currentStep > 0) {
                    goToPreviousStep();
                }
            });

            autoRunBtn.addEventListener('click', function () {
                if (isAutoRunning) {
                    stopAutoRun();
                } else {
                    startAutoRun();
                }
            });

            resetSimBtn.addEventListener('click', function () {
                Swal.fire({
                    title: 'Reset Simulation?',
                    text: 'This will reset the simulation to its initial state.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#dc3545'
                }).then((result) => {
                    if (result.isConfirmed) {
                        resetSimulation();
                        Swal.fire({
                            title: 'Simulation Reset',
                            text: 'Simulation has been reset to initial state.',
                            icon: 'success',
                            timer: 1500
                        });
                    }
                });
            });

            // Initialize jsPlumb
            instance.bind("ready", function () {
                instance.setSuspendDrawing(false);
                updateConnectionStatus();
                updateVoltageSlider();

                // Make images fallback to text if they don't load
                document.querySelectorAll('.parent img').forEach(img => {
                    img.onerror = function () {
                        this.style.display = 'none';
                        const parent = this.parentElement;
                        if (parent) {
                            const altText = this.alt || 'Component';
                            parent.innerHTML = `<div style="padding: 10px; font-weight: bold; color: #495057;">${altText}</div>`;
                            parent.querySelectorAll('.dot').forEach(dot => {
                                parent.appendChild(dot);
                            });
                        }
                    };
                });
            });

            // Handle window resize
            window.addEventListener('resize', function () {
                setTimeout(() => {
                    instance.repaintEverything();
                }, 100);
            });
        });
    </script>
</body>
</html>